{% extends "base.html" %}

{% block content %}
<div class="app-container" style="max-width: 800px; margin: 0 auto; padding: 40px 20px;">
    <!-- 헤더 -->
    <header style="text-align: center; margin-bottom: 40px;">
        <h1 style="font-size: 32px; color: #fff; margin-bottom: 10px;">Xiaohongshu Video Downloader</h1>
        <p style="color: #999; font-size: 14px;">샤오홍수 동영상을 다운로드하세요</p>
    </header>

    <!-- URL 입력 -->
    <div style="background: #1a1a1a; border-radius: 12px; padding: 30px; margin-bottom: 20px;">
        <label for="urlInput" style="display: block; color: #fff; font-size: 16px; margin-bottom: 12px; font-weight: 600;">
            동영상 URL 입력
        </label>
        <textarea
            id="urlInput"
            rows="6"
            placeholder="Xiaohongshu 동영상 URL을 입력하세요 (여러 개 가능, 한 줄에 하나씩)&#10;&#10;예시:&#10;https://www.xiaohongshu.com/explore/xxxxx&#10;https://xhslink.com/xxxxx"
            style="width: 100%; padding: 16px; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 14px; resize: vertical; font-family: monospace;"></textarea>

        <div style="margin-top: 16px;">
            <label for="qualitySelect" style="display: block; color: #fff; font-size: 14px; margin-bottom: 8px; font-weight: 500;">
                화질 선택
            </label>
            <select
                id="qualitySelect"
                style="width: 100%; padding: 12px; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 14px; cursor: pointer;">
                <option value="best">최고 화질 (원본)</option>
                <option value="1080p">1080p</option>
                <option value="720p">720p</option>
            </select>
        </div>

        <button
            onclick="downloadVideos()"
            id="downloadBtn"
            style="width: 100%; margin-top: 16px; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
            다운로드 시작
        </button>
    </div>

    <!-- 결과 표시 -->
    <div id="resultsContainer" style="display: none;">
        <div style="background: #1a1a1a; border-radius: 12px; padding: 30px;">
            <h2 style="color: #fff; font-size: 20px; margin-bottom: 20px;">다운로드 결과</h2>
            <div id="resultsList"></div>
        </div>
    </div>

    <!-- 로딩 표시 -->
    <div id="loading" style="display: none; text-align: center; padding: 40px;">
        <div style="display: inline-block; width: 50px; height: 50px; border: 4px solid #333; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p id="loadingMessage" style="color: #999; margin-top: 20px; font-size: 14px;">다운로드 중...</p>
    </div>
</div>

<style>
@keyframes spin {
    to { transform: rotate(360deg); }
}

#downloadBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
}

#downloadBtn:active {
    transform: translateY(0);
}

#downloadBtn:disabled {
    background: #333;
    cursor: not-allowed;
    transform: none;
}

.result-item {
    padding: 16px;
    background: #0a0a0a;
    border-radius: 8px;
    margin-bottom: 12px;
    border-left: 4px solid #667eea;
}

.result-item.success {
    border-left-color: #4caf50;
}

.result-item.failed {
    border-left-color: #f44336;
}

.result-url {
    color: #999;
    font-size: 12px;
    word-break: break-all;
    margin-bottom: 8px;
}

.result-status {
    color: #fff;
    font-size: 14px;
    font-weight: 600;
}

.result-error {
    color: #f44336;
    font-size: 12px;
    margin-top: 8px;
}

.result-path {
    color: #4caf50;
    font-size: 12px;
    margin-top: 8px;
    font-family: monospace;
}
</style>

<script>
async function downloadVideos() {
    const urlInput = document.getElementById('urlInput');
    const qualitySelect = document.getElementById('qualitySelect');
    const downloadBtn = document.getElementById('downloadBtn');
    const loading = document.getElementById('loading');
    const resultsContainer = document.getElementById('resultsContainer');
    const resultsList = document.getElementById('resultsList');

    const urls = urlInput.value
        .split('\n')
        .map(url => url.trim())
        .filter(url => url.length > 0);

    const quality = qualitySelect.value;

    if (urls.length === 0) {
        alert('URL을 입력해주세요');
        return;
    }

    // UI 상태 변경
    downloadBtn.disabled = true;
    loading.style.display = 'block';
    resultsContainer.style.display = 'none';
    resultsList.innerHTML = '';

    try {
        const response = await fetch('/api/downloads/quick', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ urls, quality })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || '다운로드 실패');
        }

        const data = await response.json();

        // 결과 표시
        loading.style.display = 'none';
        resultsContainer.style.display = 'block';

        if (data.results && data.results.length > 0) {
            data.results.forEach(result => {
                const item = document.createElement('div');
                item.className = `result-item ${result.status}`;

                const urlDiv = document.createElement('div');
                urlDiv.className = 'result-url';
                urlDiv.textContent = result.url;

                const statusDiv = document.createElement('div');
                statusDiv.className = 'result-status';
                statusDiv.textContent = result.status === 'success' ? '✓ 다운로드 완료' : '✗ 다운로드 실패';

                item.appendChild(urlDiv);
                item.appendChild(statusDiv);

                if (result.status === 'success' && result.file_path) {
                    const pathDiv = document.createElement('div');
                    pathDiv.className = 'result-path';
                    pathDiv.textContent = `파일 위치: ${result.file_path}`;
                    item.appendChild(pathDiv);
                } else if (result.error) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'result-error';
                    errorDiv.textContent = `오류: ${result.error}`;
                    item.appendChild(errorDiv);
                }

                resultsList.appendChild(item);
            });

            // 요약 정보
            const summary = document.createElement('div');
            summary.style.cssText = 'margin-top: 20px; padding-top: 20px; border-top: 1px solid #333; color: #999; font-size: 14px;';
            summary.textContent = `총 ${data.total}개 중 ${data.success}개 성공, ${data.failed}개 실패`;
            resultsList.appendChild(summary);
        }

    } catch (error) {
        loading.style.display = 'none';
        alert(`오류: ${error.message}`);
    } finally {
        downloadBtn.disabled = false;
    }
}
</script>
{% endblock %}
