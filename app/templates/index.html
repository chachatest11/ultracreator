{% extends "base.html" %}

{% block content %}
<div class="app-container">
    <!-- 헤더 -->
    <header class="header">
        <h1 class="logo">YouTube Shorts Downloader</h1>
        <div class="header-actions">
            <button class="btn-manage-categories" onclick="openApiKeyModal()">API 키 관리</button>
            <button class="btn-manage-categories" onclick="openCategoryModal()">카테고리 관리</button>
        </div>
    </header>

    <!-- 카테고리 탭 -->
    <div class="category-tabs-container">
        <div class="category-tabs" id="categoryTabs">
            <button
                class="category-tab active"
                data-category-id="0"
                data-channel-count="{{ total_count }}"
                onclick="selectCategory(0)">
                전체 (<span class="tab-count">{{ total_count }}</span>)
            </button>
            {% for category in categories %}
            <button
                class="category-tab"
                data-category-id="{{ category.id }}"
                data-channel-count="{{ category.channel_count }}"
                onclick="selectCategory({{ category.id }})">
                {{ category.name }} (<span class="tab-count">{{ category.channel_count }}</span>)
            </button>
            {% endfor %}
        </div>
    </div>

    <!-- 채널 관리 섹션 -->
    <div class="channels-section">
        <div class="channels-header">
            <div class="channels-header-left">
                <button class="btn-collapse" onclick="toggleChannelList()" id="channelToggleBtn">▶</button>
                <h3>등록된 채널</h3>
            </div>
            <button class="btn-primary" onclick="openAddChannelModal()">+ 채널 추가</button>
        </div>

        <div id="channelsContent" class="channels-content collapsed">
            <!-- 선택한 채널 일괄 이동 -->
            <div id="bulkMoveContainer" class="bulk-move-container" style="display: none;">
                <span class="bulk-move-info">
                    <span id="selectedChannelCount">0</span>개 선택됨
                </span>
                <select id="bulkMoveCategorySelect" class="bulk-move-select">
                    <option value="">이동할 카테고리 선택...</option>
                </select>
                <button class="btn-primary btn-small" onclick="bulkMoveChannels()">이동</button>
                <button class="btn-secondary btn-small" onclick="clearChannelSelection()">선택 해제</button>
            </div>

            <div class="channels-list" id="channelsList">
                <!-- 동적으로 채워짐 -->
            </div>
        </div>
    </div>

    <!-- 검색 조건 영역 -->
    <div class="search-section">
        <div class="api-key-input">
            <label for="apiKey">YouTube API Key</label>
            <input
                type="password"
                id="apiKey"
                placeholder="API 키를 입력하세요"
                value="">
        </div>

        <div class="search-options">
            <div class="option-group">
                <label for="maxVideos">최대 영상 수 (채널당)</label>
                <input type="number" id="maxVideos" value="50" min="1" max="100">
            </div>
            <button class="btn-primary btn-search" onclick="searchVideos()">쇼츠 검색</button>
        </div>
    </div>

    <!-- 결과 옵션 영역 -->
    <div class="result-options" id="resultOptions" style="display: none;">
        <div class="option-group">
            <label for="sortBy">정렬</label>
            <select id="sortBy" onchange="applyFilters()">
                <option value="latest">업로드일시: 최신순</option>
                <option value="oldest">업로드일시: 오래된순</option>
                <option value="views_desc">조회수: 높은순</option>
                <option value="views_asc">조회수: 낮은순</option>
                <option value="likes_desc">좋아요: 많은순</option>
                <option value="likes_asc">좋아요: 적은순</option>
                <option value="comments_desc">댓글수: 많은순</option>
                <option value="comments_asc">댓글수: 적은순</option>
            </select>
        </div>

        <div class="option-group">
            <label for="minViews">최소 조회수 (만)</label>
            <input type="number" id="minViews" value="0" min="0" onchange="applyFilters()">
        </div>

        <div class="result-info">
            <span id="resultCount">0개 영상</span>
            <span id="selectedCount" style="display: none;">0개 선택</span>
        </div>

        <button class="btn-download" id="btnDownload" onclick="downloadSelected()" style="display: none;">
            선택 영상 다운로드
        </button>

        <button class="btn-secondary" onclick="clearSearchResults()">
            검색결과 지우기
        </button>
    </div>

    <!-- 로딩 표시 -->
    <div class="loading" id="loading" style="display: none;">
        <div class="spinner"></div>
        <p id="loadingMessage">로딩 중...</p>
        <button class="btn-abort" id="btnAbort" onclick="abortSearch()" style="display: none;">검색 중지</button>
        <div id="loadingErrors" class="loading-errors"></div>
    </div>

    <!-- 결과 카드 그리드 -->
    <div class="video-grid" id="videoGrid">
        <!-- 동적으로 채워짐 -->
    </div>
</div>

<!-- 카테고리 관리 모달 -->
<div class="modal" id="categoryModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>카테고리 관리</h2>
            <button class="btn-close" onclick="closeCategoryModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- 새 카테고리 추가 -->
            <div class="add-category">
                <input type="text" id="newCategoryName" placeholder="새 카테고리 이름">
                <button class="btn-primary" onclick="addCategory()">추가</button>
            </div>

            <!-- 카테고리 목록 -->
            <div class="category-list" id="categoryList">
                <!-- 동적으로 채워짐 -->
            </div>
        </div>
    </div>
</div>

<!-- 채널 추가 모달 -->
<div class="modal" id="addChannelModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>채널 추가</h2>
            <button class="btn-close" onclick="closeAddChannelModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- 탭 헤더 -->
            <div class="upload-tabs">
                <button class="upload-tab active" onclick="switchUploadTab('manual')">수동 입력</button>
                <button class="upload-tab" onclick="switchUploadTab('file')">파일 업로드</button>
            </div>

            <!-- 수동 입력 탭 -->
            <div id="manualInputTab" class="upload-tab-content active">
                <div class="channel-input">
                    <label for="channelInput">채널 입력 (여러 줄 가능)</label>
                    <textarea
                        id="channelInput"
                        rows="6"
                        placeholder="채널 URL, @핸들, 또는 채널 ID를 입력하세요&#10;&#10;예시:&#10;https://youtube.com/@channelname&#10;https://www.youtube.com/channel/UCxxxx&#10;UCxxxx"></textarea>
                </div>
                <div style="margin-top: 16px; text-align: right;">
                    <button class="btn-primary" onclick="addChannels()">채널 저장</button>
                </div>
            </div>

            <!-- 파일 업로드 탭 -->
            <div id="fileUploadTab" class="upload-tab-content">
                <div class="channel-input">
                    <label for="mdFileInput">MD 파일 업로드</label>
                    <input type="file" id="mdFileInput" accept=".md,.txt" style="margin-bottom: 12px;">
                    <p style="color: #999; font-size: 12px; margin-bottom: 12px;">
                        Markdown 파일 내의 YouTube URL들을 자동으로 인식하여 채널을 등록합니다.
                    </p>
                    <div id="filePreview" style="background: #0a0a0a; border: 1px solid #333; border-radius: 6px; padding: 12px; max-height: 200px; overflow-y: auto; display: none;">
                        <div id="urlCountHeader" style="font-size: 12px; color: #4caf50; margin-bottom: 8px; font-weight: bold;">감지된 YouTube URL: 0개</div>
                        <div id="urlList"></div>
                    </div>
                </div>
                <div style="margin-top: 16px; text-align: right;">
                    <button class="btn-primary" onclick="uploadMdFile()">파일에서 채널 등록</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- API 키 관리 모달 -->
<div class="modal" id="apiKeyModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>API 키 관리</h2>
            <button class="btn-close" onclick="closeApiKeyModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- 새 API 키 추가 -->
            <div class="add-category">
                <input type="text" id="newApiKey" placeholder="새 API 키">
                <input type="text" id="newApiKeyName" placeholder="이름 (선택)" style="flex: 0.5;">
                <button class="btn-primary" onclick="addApiKey()">추가</button>
            </div>

            <!-- API 키 목록 -->
            <div class="category-list" id="apiKeyList">
                <!-- 동적으로 채워짐 -->
            </div>
        </div>
    </div>
</div>

<!-- 다운로드 진행 모달 -->
<div class="modal" id="downloadModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>다운로드 진행 중</h2>
            <button class="modal-close" onclick="closeDownloadModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="download-progress">
                <p id="downloadStatus">다운로드 준비 중...</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div id="downloadResults"></div>
            </div>
        </div>
    </div>
</div>

<!-- 비디오 플레이어 모달 -->
<div class="modal" id="videoPlayerModal">
    <div class="modal-content" style="max-width: 500px; width: 90vw;">
        <div class="modal-header">
            <h2 id="videoPlayerTitle">영상 재생</h2>
            <button class="btn-close" onclick="closeVideoPlayer()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 0;">
            <div id="videoPlayerContainer" style="position: relative; width: 100%; max-height: 70vh;">
                <iframe id="videoPlayerIframe"
                        style="width: 100%; height: 70vh; max-height: 888px; display: block;"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen>
                </iframe>
            </div>
        </div>
    </div>
</div>

<script>
// 전역 변수
let currentCategoryId = 0;  // 0 = 전체 탭
let currentVideos = [];
let selectedVideoIds = new Set();
let selectedChannelIds = new Set();
let apiKey = '';

// 페이지 로드 시
window.addEventListener('DOMContentLoaded', async function() {
    // API Key DB에서 불러오기
    await loadApiKey();

    // 채널 추가 버튼 숨김 ('전체' 탭에서 시작하므로)
    const addChannelBtn = document.querySelector('.channels-header .btn-primary');
    if (addChannelBtn) {
        addChannelBtn.style.display = 'none';
    }

    // 채널 목록 로드
    loadChannels();
});
</script>
{% endblock %}
